<!doctype html><html lang=en><head><title>Sentinel notes</title><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.357dd1de946e0748ed1ed88009a6203f270bccbdabe5793ab4aab15964be163a.css integrity="sha256-NX3R3pRuB0jtHtiACaYgPycLzL2r5Xk6tKqxWWS+Fjo="><link rel=icon type=image/png href=/images/site/favicon_hu_600b31f4ce216cf3.png><link rel=alternate type=application/rss+xml href=https://siemforge.xyz/notes/3.sentinel/index.xml title=SIEMForge><meta property="og:title" content="SIEMForge"><meta property="og:type" content="website"><meta property="og:description" content="Portfolio and personal blog of Benny Temmerman, SIEMForge"><meta property="og:image" content="/images/site/background.jpg"><meta property="og:url" content="https://siemforge.xyz"><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "c845fbe0ec8f4fe1b3d3db62cc771051"}'></script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-notes kind-section" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hu_600b31f4ce216cf3.png id=logo alt=Logo>
SIEMForge</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>Home</a></li><li class=nav-item><a class=nav-link href=/#about>About</a></li><li class=nav-item><a class=nav-link href=/#skills>Skills</a></li><li class=nav-item><a class=nav-link href=/#experiences>Experiences</a></li><li class=nav-item><a class=nav-link href=/#projects>Projects</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>More</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#featured-posts>Featured Posts</a>
<a class=dropdown-item href=/#accomplishments>Accomplishments</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>Posts</a></li><li class=nav-item><a class=nav-link id=note-link href=/notes>Notes</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu_600b31f4ce216cf3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu_600b31f4ce216cf3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/notes data-filter=all>Notes</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/notes/2.splunk/> Splunk</a><ul><li><a class=list-link href=/notes/2.splunk/spl/ title=SPL>SPL</a></li><li><a class=list-link href=/notes/2.splunk/gui/ title=GUI>GUI</a></li><li><a class=list-link href=/notes/2.splunk/cli/ title=CLI>CLI</a></li><li><a class=list-link href=/notes/2.splunk/splunk-upgrade/ title=Upgrade>Upgrade</a></li></ul></li><li><i data-feather=minus-circle></i><a class="active list-link" href=/notes/3.sentinel/> Sentinel</a><ul class=active><li><a class=list-link href=/notes/3.sentinel/kql/ title=KQL>KQL</a></li><li><a class=list-link href=/notes/3.sentinel/logstash_cli/ title="Logstash CLI">Logstash CLI</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/4.linux/> Linux</a><ul><li><a class=list-link href=/notes/4.linux/cli/ title=Bash>Bash</a></li><li><a class=list-link href=/notes/4.linux/logrotate/ title=Logrotate>Logrotate</a></li><li><a class=list-link href=/notes/4.linux/lvm/lvm_cheatsheet/ title="LVM cheatsheet">LVM cheatsheet</a></li><li><a class=list-link href=/notes/4.linux/fdisk/ title=fdisk>fdisk</a></li><li><a class=list-link href=/notes/4.linux/tcpdump/tcpdump_cheatsheet/ title="TCPDump cheatsheet">TCPDump cheatsheet</a></li><li><a class=list-link href=/notes/4.linux/scripts/addsudouser/ title=script-SudoUser>script-SudoUser</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/5.tools/> Tools</a><ul><li><a class=list-link href=/notes/5.tools/ncdu/ title=ncdu>ncdu</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/6.coding/> Coding</a><ul><li><a class=list-link href=/notes/6.coding/python/ title=Python>Python</a></li><li><a class=list-link href=/notes/6.coding/git/ title=GIT>GIT</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class="content container-fluid" id=content><div class="container-fluid note-card-holder" id=note-card-holder><div style=display:block;width:100%;max-width:none><div class=note-card><div class=item><h5 class=note-title><span>Troubleshooting:</span></h5><div class=card><div class=card-body><h1 id=troubleshooting>Troubleshooting</h1><p>A collection of KQL I use to troubleshoot incidents in Sentinel.</p><h2 id=failed-analytics-rule>Failed analytics rule</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SentinelHealth
</span></span><span style=display:flex><span>| where SentinelResourceName startswith <span style=color:#e6db74>&#34;AnalyticsRule -&#34;</span>
</span></span><span style=display:flex><span>| where OperationName <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Scheduled analytics rule run&#34;</span>
</span></span><span style=display:flex><span>| where Status <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Failure&#34;</span>
</span></span><span style=display:flex><span>| summarize count<span style=color:#f92672>(</span>Status<span style=color:#f92672>)</span> by SentinelResourceName
</span></span><span style=display:flex><span>| where count_Status &gt; <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>| extend info_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;failed_analytic-rule&#34;</span>
</span></span><span style=display:flex><span>| extend info_sub_route <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sentinel&#34;</span>
</span></span></code></pre></div><p>Detects rules that have failed more than three times, indicating potential issues with rule execution.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SentinelHealth
</span></span><span style=display:flex><span>| where SentinelResourceName in <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Successful logon from IP and failure from a different IP&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| where Status <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Failure&#34;</span>
</span></span><span style=display:flex><span>| project TimeGenerated, SentinelResourceName, Status
</span></span><span style=display:flex><span>| sort by TimeGenerated desc
</span></span></code></pre></div><p>Finding the failed runs of an analytics rule can help narrow down the time window to investigate further.
<strong>SentinelHealth</strong><br>Selects data from the SentinelHealth table.<br><strong>| where SentinelResourceName in (&ldquo;Successful logon from IP and failure from a different IP&rdquo;)</strong><br>Filters records to include only those with specific resource names related to logon success and failure.<br><strong>| where Status == &ldquo;Failure&rdquo;</strong><br>Further filters the data to include only failed login attempts.<br><strong>| project TimeGenerated, SentinelResourceName, Status</strong><br>Selects only the columns for the time of the event, resource name, and status.<br><strong>| sort by TimeGenerated desc</strong><br>Orders the results by the most recent events first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SentinelHealth
</span></span><span style=display:flex><span>| where SentinelResourceName in <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Successful logon from IP and failure from a different IP&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| project TimeGenerated, SentinelResourceName, Status
</span></span><span style=display:flex><span>| sort by TimeGenerated desc
</span></span></code></pre></div><p>Expand the failed run time window to investigate warnings or successful runs. It is possible that Sentinel runs out of resources where a failed run can be expected and closed as true benign positive, expected behavior. Multiple failed runs might indicate another issue with the analytics rule (Syntax related or other) after an update of the rule. Further investigation is needed to resolve the issue.</p><h2 id=table-does-not-receive-data>Table does not receive data</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>union withsource<span style=color:#f92672>=</span>TableName
</span></span><span style=display:flex><span>vcenter_CL, SecurityEvent, CommonSecurityLog, Syslog // Add/remove tables as needed
</span></span><span style=display:flex><span>| where TimeGenerated &gt;<span style=color:#f92672>=</span> ago<span style=color:#f92672>(</span>7d<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| summarize MinutesSinceLastEvent <span style=color:#f92672>=</span> datetime_diff<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;minute&#34;</span>, now<span style=color:#f92672>()</span>, max<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>))</span>, LastIngestionTime <span style=color:#f92672>=</span> max<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>)</span> by TableName
</span></span><span style=display:flex><span>| where MinutesSinceLastEvent &gt;<span style=color:#f92672>=</span> <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>| project TableName, alert_minutes_last_event <span style=color:#f92672>=</span> MinutesSinceLastEvent, LastIngestionTime
</span></span><span style=display:flex><span>| extend info_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;table_not_receiving-data&#34;</span>
</span></span><span style=display:flex><span>| extend info_sub_route <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sentinel&#34;</span>
</span></span></code></pre></div><p>Identifies tables that haven&rsquo;t received data for over an hour, signaling possible ingestion problems.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SecurityAlert
</span></span><span style=display:flex><span>| summarize EventCount <span style=color:#f92672>=</span> count<span style=color:#f92672>()</span> by bin<span style=color:#f92672>(</span>TimeGenerated, 1h<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| render timechart
</span></span></code></pre></div><p>This query counts the amount of events per hour and renders it in a timechart. This is an easy way to pinpoint anomalies in log event ingestion.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SecurityAlert
</span></span><span style=display:flex><span>| where TimeGenerated &gt;<span style=color:#f92672>=</span> ago<span style=color:#f92672>(</span>30d<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| sort by TimeGenerated asc
</span></span><span style=display:flex><span>| serialize
</span></span><span style=display:flex><span>| extend TimeDiff <span style=color:#f92672>=</span> datetime_diff<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;second&#39;</span>, TimeGenerated, prev<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>| where TimeDiff &gt;<span style=color:#f92672>=</span> <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>| project TimeGenerated, prev_TimeGenerated<span style=color:#f92672>=</span>prev<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>)</span>, TimeDiff
</span></span></code></pre></div><p>Statistical overview of gaps (over 1 hour) between events for the last 30 days. This one is mostly used to determine tuning for the threshold used in an analytic rule to check if a table did not receive data. (could indicate a logsource stopped sending or a misconfiguration in sending the logs to another table)</p><h2 id=silent-logsource>Silent logsource</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> let _SecurityEvent <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>   SecurityEvent
</span></span><span style=display:flex><span>   | where TimeGenerated &gt; ago<span style=color:#f92672>(</span>15d<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   | summarize
</span></span><span style=display:flex><span>       MinutesSinceLastEvent <span style=color:#f92672>=</span> datetime_diff<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;minute&#34;</span>, now<span style=color:#f92672>()</span>, max<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>))</span>,
</span></span><span style=display:flex><span>       LastIngestionTime <span style=color:#f92672>=</span> max<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>       by
</span></span><span style=display:flex><span>       Asset <span style=color:#f92672>=</span> Computer,
</span></span><span style=display:flex><span>       Table <span style=color:#f92672>=</span> Type,
</span></span><span style=display:flex><span>       sourcetype <span style=color:#f92672>=</span> EventSourceName
</span></span><span style=display:flex><span> ;
</span></span><span style=display:flex><span> let _Syslog <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>   Syslog
</span></span><span style=display:flex><span>   | where TimeGenerated &gt; ago<span style=color:#f92672>(</span>15d<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   | summarize
</span></span><span style=display:flex><span>       MinutesSinceLastEvent <span style=color:#f92672>=</span> datetime_diff<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;minute&#34;</span>, now<span style=color:#f92672>()</span>, max<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>))</span>,
</span></span><span style=display:flex><span>       LastIngestionTime <span style=color:#f92672>=</span> max<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>       by 
</span></span><span style=display:flex><span>       Asset <span style=color:#f92672>=</span> Computer, 
</span></span><span style=display:flex><span>       Table <span style=color:#f92672>=</span> Type
</span></span><span style=display:flex><span>       //sourcetype <span style=color:#f92672>=</span> strcat<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>       //         iff<span style=color:#f92672>(</span>DeviceVendor <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Fortinet&#34;</span>, DeviceEventCategory, <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>       //         iff<span style=color:#f92672>(</span>DeviceVendor <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Palo Alto Networks&#34;</span>, Activity, <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>       //         iff<span style=color:#f92672>(</span>DeviceVendor <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;F5&#34;</span>, DeviceProduct, <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>       //     <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> ;
</span></span><span style=display:flex><span> let _Heartbeat <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>   Heartbeat
</span></span><span style=display:flex><span>   | where TimeGenerated &gt; ago<span style=color:#f92672>(</span>15d<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   | summarize
</span></span><span style=display:flex><span>       MinutesSinceLastEvent <span style=color:#f92672>=</span> datetime_diff<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;minute&#34;</span>, now<span style=color:#f92672>()</span>, max<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>))</span>,
</span></span><span style=display:flex><span>       LastIngestionTime <span style=color:#f92672>=</span> max<span style=color:#f92672>(</span>TimeGenerated<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>       by
</span></span><span style=display:flex><span>       Asset <span style=color:#f92672>=</span> Computer,
</span></span><span style=display:flex><span>       Table <span style=color:#f92672>=</span> Type,
</span></span><span style=display:flex><span>       sourcetype <span style=color:#f92672>=</span> Type
</span></span><span style=display:flex><span> ;
</span></span><span style=display:flex><span> union _SecurityEvent, _Syslog, _Heartbeat
</span></span><span style=display:flex><span> | join _GetWatchlist<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;CriticalLogs&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   on
</span></span><span style=display:flex><span>   $left.Asset <span style=color:#f92672>==</span> $right.Host,
</span></span><span style=display:flex><span>   $left.sourcetype <span style=color:#f92672>==</span> $right.SubType,
</span></span><span style=display:flex><span>   $left.Table <span style=color:#f92672>==</span> $right.DataTable
</span></span><span style=display:flex><span> | where Maintenance !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TRUE&#34;</span>
</span></span><span style=display:flex><span> | where MinutesSinceLastEvent &gt; toint<span style=color:#f92672>(</span>Threshold<span style=color:#f92672>)</span> * <span style=color:#ae81ff>60</span> // Watchlist in hours need to convert to min
</span></span><span style=display:flex><span> | project Table, Asset, MinutesSinceLastEvent, sourcetype, SubType, Threshold, LastIngestionTime
</span></span><span style=display:flex><span> | extend info_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;critical_log_source_goes-silent&#34;</span>
</span></span><span style=display:flex><span> | extend info_sub_route <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sentinel&#34;</span>
</span></span></code></pre></div><p>Finds critical logs from assets that haven&rsquo;t reported in over a specified threshold, suggesting potential issues or outages.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SecurityEvent 
</span></span><span style=display:flex><span>| where Computer contains <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;test-pc&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| summarize Type <span style=color:#f92672>=</span> count<span style=color:#f92672>()</span> by Computer, bin<span style=color:#f92672>(</span>TimeGenerated, 1h<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>| render timechart
</span></span></code></pre></div><p>This KQL query filters security events to include only those from computers with &ldquo;test-pc&rdquo; in their name, then counts the number of events for each computer grouped by 1-hour intervals, and finally displays the results as a time chart. I use this to check for patterns in log ingestion which can indicate ingestion issues or expected behavior.</p></div></div></div></div><div class=note-card><div class=item><h5 class=note-title><span>Reporting:</span></h5><div class=card><div class=card-body><h1 id=reporting>Reporting</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>_GetWatchlist<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;CriticalLogs&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| project Host, Vendor <span style=color:#f92672>=</span> SubType, Threshold, Table <span style=color:#f92672>=</span> DataTable, Updated <span style=color:#f92672>=</span> LastUpdatedTimeUTC
</span></span></code></pre></div><p>Example query to display the content of a watchlist in Azure Sentinel. Columns are renamed in output using following format &ldquo;<new name> = <original name>&rdquo;, project operator only returns provided columns.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Usage
</span></span><span style=display:flex><span>| where IsBillable <span style=color:#f92672>==</span> true
</span></span><span style=display:flex><span>| where QuantityUnit <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;MBytes&#34;</span>
</span></span><span style=display:flex><span>| summarize totalMB <span style=color:#f92672>=</span> sum<span style=color:#f92672>(</span>Quantity<span style=color:#f92672>)</span> by day <span style=color:#f92672>=</span> bin<span style=color:#f92672>(</span>TimeGenerated, 1d<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| summarize avgGBperDay <span style=color:#f92672>=</span> round<span style=color:#f92672>(</span>avg<span style=color:#f92672>(</span>totalMB / 1024<span style=color:#f92672>)</span>, 2<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>A Sentinel KQL query to extract the average daily volume, adjust time range as needed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Usage
</span></span><span style=display:flex><span>| where IsBillable <span style=color:#f92672>==</span> true
</span></span><span style=display:flex><span>| where QuantityUnit <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;MBytes&#34;</span>
</span></span><span style=display:flex><span>| summarize totalMB <span style=color:#f92672>=</span> sum<span style=color:#f92672>(</span>Quantity<span style=color:#f92672>)</span> by day <span style=color:#f92672>=</span> bin<span style=color:#f92672>(</span>TimeGenerated, 1d<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| extend GB <span style=color:#f92672>=</span> round<span style=color:#f92672>(</span>totalMB / 1024, 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>| order by day asc
</span></span></code></pre></div><p>A Sentinel KQL query aggregated the total number of bytes ingested per day.</p></div></div></div></div></div><div style=display:block;width:100%;max-width:none><div class=note-card><div class=item><h5 class=note-title><span></span></h5><div class=card><div class=card-body><h1 id=logstash-management>Logstash management</h1><p>I found these notes from a colleague who worked on a Logstash machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>alias logtail<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;tail -f /var/log/logstash/logstash-plain.log&#39;</span>
</span></span><span style=display:flex><span>alias logconf<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;cd /etc/logstash/conf.d&#39;</span>
</span></span><span style=display:flex><span>alias logstart<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;systemctl start logstash&#39;</span>
</span></span><span style=display:flex><span>alias logstop<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;systemctl stop logstash&#39;</span>
</span></span><span style=display:flex><span>alias logrestart<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;systemctl restart logstash&#39;</span>
</span></span><span style=display:flex><span>alias logstatus<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;systemctl status logstash&#39;</span>
</span></span><span style=display:flex><span>alias logsamp<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;cd /usr/share/logstash/samples&#39;</span>
</span></span></code></pre></div><p><strong>logtail:</strong> Continuously displays new entries in the Logstash log file.<br><strong>logconf:</strong> Navigates to the Logstash configuration directory.<br><strong>logstart:</strong> Starts the Logstash service.<br><strong>logstop:</strong> Stops the Logstash service.<br><strong>logrestart:</strong> Restarts the Logstash service.<br><strong>logstatus:</strong> Checks the current status of the Logstash service.<br><strong>logsamp:</strong> Navigates to the directory containing sample Logstash configurations.</p><h3 id=making-alias-permanent-for-all-users>Making alias permanent for all users</h3><p>To ensure these aliases are available for all users permanently, you can add them to a global shell configuration file such as /etc/bashrc, /etc/bash.bashrc, or /etc/profile, depending on your system and shell preferences.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/bashrc
</span></span></code></pre></div><p>Edit bashrc file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>alias logtail<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;tail -f /var/log/logstash/logstash-plain.log&#39;</span>
</span></span><span style=display:flex><span>alias logconf<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;cd /etc/logstash/conf.d&#39;</span>
</span></span><span style=display:flex><span>alias logstart<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;systemctl start logstash&#39;</span>
</span></span><span style=display:flex><span>alias logstop<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;systemctl stop logstash&#39;</span>
</span></span><span style=display:flex><span>alias logrestart<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;systemctl restart logstash&#39;</span>
</span></span><span style=display:flex><span>alias logstatus<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;systemctl status logstash&#39;</span>
</span></span><span style=display:flex><span>alias logsamp<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;cd /usr/share/logstash/samples&#39;</span>
</span></span></code></pre></div><p>add the alias commands at the end of the file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>source /etc/bashrc
</span></span></code></pre></div><p>Save the file and reload the shell configuration.</p></div></div></div></div></div></div><div class=paginator></div></div></section></div><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "c845fbe0ec8f4fe1b3d3db62cc771051"}'></script><script src=https://storage.ko-fi.com/cdn/scripts/overlay-widget.js></script><script>kofiWidgetOverlay.draw("siemforge",{type:"floating-chat","floating-chat.donateButton.text":"Support me","floating-chat.donateButton.background-color":"#00b9fe","floating-chat.donateButton.text-color":"#fff"})</script><script src=/application.fda7b48a8d3c362b0b790a3314272696a7a899a2e1ea88f0bfb6823f2191c23c.js integrity="sha256-/ae0io08NisLeQozFCcmlqeomaLh6ojwv7aCPyGRwjw=" defer></script></body></html>